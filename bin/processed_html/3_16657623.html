<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="X-UA-Compatible" content="ie=edge"><head><link href="../../src/css/general.css" rel="stylesheet" /></head><div class='.s-prose'>

<p>Just found my own way:</p>

<p>First of all, I don't really remember why I put this line here, but it was messing up my code:</p>

<pre><code>&lt;security:http-basic /&gt;
</code></pre>

<p>Second, this answer show me the path: <a href="https://stackoverflow.com/questions/4397062/handle-unauthorized-error-message-for-basic-authentication-in-spring-security">Handle unauthorized error message for Basic Authentication in Spring Security</a>. I had to create a custom authentication entry point in order to send the Access-Control-Allow-Origin thing.</p>

<p>So this is my code now:</p>

<pre class="lang-xml prettyprint-override"><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:security="http://www.springframework.org/schema/security"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="
              http://www.springframework.org/schema/beans
              http://www.springframework.org/schema/beans/spring-beans-3.2.xsd
              http://www.springframework.org/schema/security
              http://www.springframework.org/schema/security/spring-security-3.1.xsd"&gt;

    &lt;security:http create-session="stateless"
        entry-point-ref="authenticationEntryPoint"&gt;
        &lt;security:intercept-url pattern="/api/admin/**" /&gt;
        &lt;security:intercept-url pattern="/medico/**" /&gt;
        &lt;!-- &lt;security:http-basic /&gt;  --&gt;
        &lt;security:custom-filter ref="basicAuthenticationFilter"
            after="BASIC_AUTH_FILTER" /&gt;
    &lt;/security:http&gt;

    &lt;bean id="basicAuthenticationFilter"
        class="org.springframework.security.web.authentication.www.BasicAuthenticationFilter"&gt;
        &lt;property name="authenticationManager" ref="authenticationManager" /&gt;
        &lt;property name="authenticationEntryPoint" ref="authenticationEntryPoint" /&gt;
    &lt;/bean&gt;

            &lt;!-- 
    &lt;bean id="authenticationEntryPoint" 
        class="org.springframework.security.web.authentication.www.BasicAuthenticationEntryPoint"&gt;
        &lt;property name="realmName" value="test.com" /&gt;
    &lt;/bean&gt; --&gt;


    &lt;bean id="authenticationEntryPoint" 
        class="com.test.util.PlainTextBasicAuthenticationEntryPoint"&gt;
        &lt;property name="realmName" value="test.com" /&gt;
    &lt;/bean&gt; 

    &lt;!-- It is responsible for validating the user's credentials --&gt;
    &lt;security:authentication-manager alias="authenticationManager"&gt;

        &lt;!-- It is responsible for providing credential validation to the AuthenticationManager --&gt;
        &lt;security:authentication-provider&gt;
            &lt;security:password-encoder ref="passwordEncoder" /&gt;

            &lt;security:jdbc-user-service
                data-source-ref="mySQLdataSource"
                users-by-username-query="select username, password, enabled from usuario where username = ?"
                authorities-by-username-query="select username, papel from autoridade where username = ?" /&gt;

        &lt;/security:authentication-provider&gt;

    &lt;/security:authentication-manager&gt;

    &lt;bean
        class="org.springframework.security.crypto.password.StandardPasswordEncoder"
        id="passwordEncoder" /&gt;

&lt;/beans&gt;
</code></pre>

<pre class="lang-java prettyprint-override"><code>package com.test.util;

import java.io.IOException;
import java.io.PrintWriter;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.springframework.security.core.AuthenticationException;
import org.springframework.security.web.authentication.www.BasicAuthenticationEntryPoint;

public class PlainTextBasicAuthenticationEntryPoint extends
        BasicAuthenticationEntryPoint {

      @Override
        public void commence(HttpServletRequest request, HttpServletResponse response, AuthenticationException authException) throws IOException, ServletException {
            response.addHeader("Access-Control-Allow-Origin", "null");
            response.addHeader("WWW-Authenticate", "Basic realm=\"" + getRealmName() + "\"");
            response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
            PrintWriter writer = response.getWriter();
            writer.println("HTTP Status " + HttpServletResponse.SC_UNAUTHORIZED + " - " + authException.getMessage());
        }

}
</code></pre>

<p>My http response now:</p>

<pre><code>HTTP/1.1 401 Unauthorized
Server: Apache-Coyote/1.1
Access-Control-Allow-Origin: null
WWW-Authenticate: Basic realm="test.com"
Content-Length: 35
Date: Mon, 20 May 2013 20:05:03 GMT

HTTP Status 401 - Bad credentials
</code></pre>

<p>before the alteration, I got this error message:</p>

<pre><code>OPTIONS http://localhost:8080/test/customer/name 200 (OK) jquery-1.8.2.min.js:2
XMLHttpRequest cannot load http://localhost:8080/test/customer/name. Origin null is     not allowed by Access-Control-Allow-Origin. 
</code></pre>

<p>and now as expected I get this one:</p>

<pre><code>OPTIONS http://localhost:8080/test/customer/name 200 (OK) jquery-1.8.2.min.js:2
POST http://localhost:8080/test/customer/name 401 (Unauthorized) 
</code></pre>
    
</div></body></html>